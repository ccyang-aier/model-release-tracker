# Model Release Tracker（v1）需求分析文档

## 1. 背景

Model Release Tracker（MRT）v0 已实现最小可用闭环：多平台轮询 -> 统一事件 -> 规则匹配 -> SQLite 幂等去重与断点续跑 -> 多渠道通知（WeLink/Email）。

在真实运行中，v0 暴露出典型“生产化”问题：通知失败、限流、网络抖动、重启恢复、规则演进带来的补发/漏发争议、缺少可观测性与可运营能力等。v1 的目标是在保持 v0 架构边界清晰的基础上，围绕可靠性、稳定性、新特性、与 AI 结合、拓宽应用场景做系统性增强。

## 2. 目标与非目标

### 2.1 v1 目标

- 可靠性：通知“至少一次投递”可落地，避免因为瞬时失败导致永久漏报；提供可控重试与补偿机制。
- 稳定性：提升在高频轮询、分页数据、限流/429、接口波动下的稳定性，避免状态推进不一致导致的跳跃/断档。
- 可运营：增强可观测性与排障手段（指标、日志、失败可追踪），支持日常运行维护。
- 规则能力：从“关键词”升级到可表达的规则系统（正则、字段过滤、事件类型、来源白名单、优先级）。
- 新特性：告警聚合/降噪、模板化通知、补发与回放（replay）能力。
- AI 结合：引入“可选”的 AI 增强能力（摘要、分类、相似聚类、语义匹配），在不依赖 AI 的情况下系统仍可用。
- 场景拓展：从“社区模型/代码更新”扩展到“研究/安全/依赖/内部模型仓库”等更广泛的发布与变更监控。

### 2.2 v1 非目标（后续版本演进）

- 完整分布式部署与水平扩展（v1 仍以单机/单进程稳定可运行为主）。
- 全量实时化（如 GitHub webhook 全覆盖、全平台 webhook）作为默认模式；v1 可以提供可选 webhook 能力，但不强依赖。
- 完整的可视化管理后台（v1 可以先以 CLI + SQLite/导出报表为主，必要时加轻量 Web）。

## 3. 核心用户与使用场景

### 3.1 核心用户

- 研发/架构：关注开源框架（vLLM/SGLang 等）对特定模型/特性（DeepSeek/Qwen）支持动态。
- 算法/平台：关注 HuggingFace/ModelScope 上组织模型的新增/更新与重要变更。
- 运维/安全：关注依赖组件、镜像、模型供应链的安全通告与高风险变更。
- 企业内部平台团队：监控内部模型仓库/评测平台的版本发布与灰度状态。

### 3.2 典型场景

- 社区更新哨兵：持续监控 GitHub PR/Issue 与模型仓库更新，第一时间推送到 IM 群。
- 版本发布跟踪：捕捉 release/tag、模型卡更新、权重新增、推理镜像发布等信号。
- 降噪与聚合：同一版本在短时间多次更新时合并通知；对相似事件聚类后“总结式提醒”。
- 复盘与追溯：按时间范围回放事件，支持“从某日期开始补发”。
- 智能筛选：用 AI 将“真正相关”事件从噪声里分离出来，并生成可读摘要与影响评估。

## 4. v0 现状与痛点分析

### 4.1 可靠性痛点

- 通知失败后的补偿策略：v0 仅记录失败，若推进了状态可能导致永久漏报。
- 通知与状态推进的事务边界不清晰：需要明确“成功后再推进”的原则，避免中间断档。

### 4.2 稳定性痛点

- 上游接口分页、排序、限流策略差异较大：缺少统一的限流/退避策略与健康检查手段。
- 规则变更后的历史补发：v0 默认未命中也会记 seen，会造成“规则后来变更也不会补发”，容易引起运营上的困惑。

### 4.3 可运营痛点

- 缺少结构化指标：每轮拉取多少、匹配多少、通知成功/失败多少、失败原因分布等。
- 排障依赖日志与人工猜测：缺少“事件级别的 trace（fingerprint -> 告警 -> 通知结果）”汇总。

## 5. v1 总体设计原则

- 保持分层：Source / Normalize / Rules / State / Notify 边界不破坏，新增能力优先通过扩展模块实现。
- 默认安全：token/密钥只通过环境变量；避免敏感信息输出到日志与持久化。
- 可选增强：AI 能力通过开关启用；离线/无网络/无 AI 时仍可运行核心流程。
- 可回放：状态推进、事件处理要可追踪，允许在可控条件下进行 replay 与补发。

## 6. v1 需求清单（按维度）

### 6.1 可靠性（R）

#### R1. 通知投递语义与补偿

- 目标：避免单次通知失败造成永久漏报。
- 需求：
  - 将通知从“同步发送 + 立刻落 seen/cursor”演进为“可补偿”的投递模型。
  - 引入“投递状态”概念：pending / sent / failed / retrying / dead-letter。
  - 支持指数退避 + 抖动重试，支持最大重试次数与最大延迟上限。
  - 支持按渠道独立重试（WeLink 失败不影响 Email，反之亦然）。

#### R2. Outbox / 发送队列（本地化）

- 目标：在单机条件下实现可恢复的“发送队列”，重启不丢任务。
- 需求：
  - 在 SQLite 中新增 outbox 表（或 notify_tasks 表）持久化待发送任务。
  - Runner 生成告警后写入 outbox，Sender 负责从 outbox 拉取并发送。
  - 支持“发送 worker 数量/并发度”配置，避免对下游 webhook 造成压力。

#### R3. 状态推进与事务边界

- 目标：明确“何时推进 cursor、何时 mark_seen”的一致性规则。
- 需求：
  - 默认策略：同一 source 的本轮事件在成功投递（或进入 outbox 且被确认接管）后才推进 cursor；失败时不推进（保证可重试/可回放）。
  - 支持策略配置：strict（严格成功后推进）与 best-effort（尽量推进但保留失败任务）。

### 6.2 稳定性（S）

#### S1. 限流与退避治理

- 目标：在 429/5xx/网络抖动时更加平滑，减少雪崩式重试。
- 需求：
  - 为 Source 引入统一的“限流预算”与“退避策略”，并将关键参数可配置化。
  - 对上游平台（GitHub/HF/ModelScope）分别设置默认限流配置与超时。

#### S2. 轮询调度与并发

- 目标：多 source 时减少相互影响，并允许更快的整体吞吐。
- 需求：
  - 支持 source 级并发（可配置并发数），并保证单个 source 内事件顺序稳定。
  - 引入“分组调度”：例如 GitHub 多 repo 同域名，可统一限流池。

#### S3. 数据一致性与去重策略增强

- 目标：避免上游字段变动导致重复/漏报；兼容“同一事件多次更新”。
- 需求：
  - 支持可插拔 fingerprint 策略：默认稳定字段；对部分 source 可加入 version/tag 等更合理的 event_id。
  - 支持时间窗口去重：同一资源在窗口内多次更新可合并为一个告警（可选）。

### 6.3 新特性（F）

#### F1. 规则系统升级

- 目标：让规则表达能力从关键词扩展到可配置策略。
- 需求：
  - 支持规则类型：关键词、正则、字段过滤（source/resource_type/event_type）、作者/组织 allowlist/blocklist。
  - 支持规则优先级与动作：notify / suppress / aggregate / tag（为告警打标签）。
  - 支持“规则变更后的补发策略”：可配置是否对历史未命中事件进行回放（见 F3）。

#### F2. 告警聚合与降噪

- 目标：减少群消息刷屏，提高可读性。
- 需求：
  - 支持按（source, resource_id, event_type）在 N 分钟内聚合为一条通知。
  - 支持“每日摘要/每小时摘要”模式：统计型通知 + 链接到详细列表（可落 SQLite 或导出文件）。

#### F3. 回放（Replay）与补发

- 目标：支持从指定时间点/指定 source 回放，解决规则变更或历史漏报后的补偿。
- 需求：
  - 提供 CLI：按时间范围查询 alerts/events，并支持重新投递（可选按渠道）。
  - 支持“重置 cursor 到某时间点”的安全操作（带确认与备份建议）。

#### F4. 事件详情增强

- 目标：提升通知内容质量，降低点开链接成本。
- 需求：
  - GitHub：包含 labels、作者、合并状态、关键 diff 摘要（可选）。
  - HuggingFace：包含 pipeline_tag、库依赖、模型卡关键字段变更（可选）。
  - 统一在通知中给出“命中原因（规则）+ 关键字段摘要”。

### 6.4 与 AI 结合（AI）

AI 能力在 v1 定位为“可选增强”，默认关闭，确保可用性与成本可控。

#### AI1. 智能摘要（Summarization）

- 输入：事件 raw + title/summary + 上游链接（可选抓取补充内容）。
- 输出：简短摘要（1~5 行）、变更要点、潜在影响（可选）。
- 用途：替代“原始 body 截断”，让通知更可读。

#### AI2. 语义匹配与规则增强（Semantic Rules）

- 目标：减少纯关键词匹配的漏报与误报。
- 需求：
  - 支持 embedding 相似度匹配：将事件与“关注主题描述”做语义相似度判断。
  - 支持关键词扩展建议：从历史命中事件中学习候选关键词/同义词。

#### AI3. 聚类与重复检测（Clustering）

- 目标：同一主题在短时间内多次出现时自动聚合。
- 需求：
  - 基于文本相似度/embedding 对事件聚类，生成“聚类摘要通知”。

#### AI4. 智能分流（Triage）

- 目标：让重要事件更突出。
- 需求：
  - 事件打分：重要性/紧急度/相关性评分（可训练或规则+模型）。
  - 支持高分事件即时推送、低分进入摘要。

### 6.5 拓宽应用场景（E）

#### E1. 新数据源扩展

- 目标：风从“模型/代码”拓展到更广泛的发布与险信息。
- 候选：
  - GitHub Releases/Tags（而不仅是 PR/Issue）。
  - PyPI / npm / Docker Hub / GHCR（依赖包与镜像版本发布）。
  - CVE / OSV / GHSA 安全通告（供应链风险）。
  - arXiv / Papers with Code（论文发布与 SOTA 更新）。
  - 企业内部：私有 GitLab、内部模型仓库/镜像仓库、评测平台（通过自定义 Source 接口接入）。

#### E2. 通知渠道扩展

- 候选：飞书/钉钉/Slack/企业微信，支持富文本卡片与线程化讨论。

## 7. 配置与兼容性设计

### 7.1 配置格式

- 保持 v0 JSON 配置可用，v1 新增字段做到“向后兼容”：
  - 新增：rules（复杂规则）、delivery（投递/重试）、observability（指标/日志）、ai（可选增强）、aggregation（聚合策略）。

### 7.2 状态库迁移

- SQLite schema 需要版本化迁移：
  - 新增 outbox/notify_tasks 表、rule_versions、event_log（可选）。
  - 提供自动迁移（启动时执行），并保证老库可平滑升级。

## 8. 可观测性与运维（O）

### 8.1 指标（Metrics）

- 每轮/每 source：
  - events_fetched / events_processed / events_skipped_seen / events_matched
  - alerts_created / notify_successes / notify_failures
  - http 状态码分布、重试次数、耗时分布
- 输出方式：
  - v1 MVP：日志结构化输出（JSON 行）+ SQLite 汇总表
  - 可选：Prometheus exporter

### 8.2 日志与审计

- 关键链路：event fingerprint -> alert -> outbox task -> send result
- 提供 CLI 查询：按 fingerprint / 时间段 / source_key 检索失败原因与重试历史。

## 9. 里程碑与交付物（建议拆分）

### 9.1 v1.0（可靠性优先）

- outbox + 发送 worker（R1/R2）
- 状态推进一致性策略可配置（R3）
- 基础指标与失败查询 CLI（O）
- 规则系统 v1（正则 + 字段过滤）（F1）

### 9.2 v1.1（降噪与回放）

- 聚合通知（F2）
- replay 与补发（F3）
- 更多 source：GitHub release/tag（E1）

### 9.3 v1.2（AI 可选增强）

- 摘要（AI1）
- 语义匹配（AI2）
- 聚类（AI3）与分流（AI4）

## 10. 验收标准（摘选）

- 通知失败不会导致事件永久漏报；重启后能继续投递直到成功或进入死信队列。
- 同一 SQLite state 下，daemon 中断并重启不重复发送已成功投递事件。
- 能定位“为什么漏报/为什么重复报”：提供可追溯的任务与失败记录。
- 新规则上线可控：支持选择是否对历史回放补发，且操作有审计记录。
- v0 配置文件在 v1 仍可运行（至少核心 GitHub/HF/ModelScope + WeLink）。

## 11. 风险与对策

- 上游接口不稳定/变更：对 Source 增加契约测试与“降级策略”（减少字段依赖，必要时解析 HTML 作为备选）。
- AI 成本与不确定性：默认关闭；提供缓存、速率限制、以及“失败回退到非 AI 文本”的兜底。
- 规则复杂度上升：引入规则优先级与冲突检测；提供 dry-run 模式预览匹配结果。

